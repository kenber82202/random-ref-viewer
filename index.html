<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Random Image Navigator</title>
<style>
  body {
    margin: 0; padding: 0;
    background: #000;
    color: #fff;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    justify-content: center;
    align-items: center;
  }
  img {
    max-width: 90vw;
    max-height: 70vh;
    margin-bottom: 1em;
    border: 3px solid #fff;
  }
  button {
    font-size: 1.5em;
    margin: 0 1em;
    padding: 0.5em 1.5em;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background: #222;
    color: #fff;
    user-select: none;
  }
  button:disabled {
    opacity: 0.4;
    cursor: default;
  }
  #nav {
    display: flex;
    justify-content: center;
    width: 100%;
  }
</style>
</head>
<body>

<img id="mainImage" src="" alt="Random Image" />
<div id="nav">
  <button id="backBtn" disabled>&larr; Back</button>
  <button id="forwardBtn" disabled>Forward &rarr;</button>
</div>

<script>
  let links = [];
  let currentIndex = 0;
  let historyStack = []; // previous 3 indices
  let forwardStack = []; // next 3 indices (preloaded)
  const maxHistory = 3;
  const maxPreload = 3;

  const imgElement = document.getElementById('mainImage');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');

  // Preload function caches images by creating Image objects
  function preloadImage(url) {
    const img = new Image();
    img.src = url;
  }

  // Update buttons enabled/disabled
  function updateButtons() {
    backBtn.disabled = historyStack.length === 0;
    forwardBtn.disabled = (currentIndex >= links.length - 1);
  }

  // Show image at given index
  function showImage(index) {
    currentIndex = index;
    imgElement.src = links[currentIndex];
    imgElement.alt = `Image ${currentIndex + 1} of ${links.length}`;
    updateButtons();

    // Preload next 3 images if any
    for(let i = currentIndex + 1; i <= currentIndex + maxPreload && i < links.length; i++) {
      preloadImage(links[i]);
    }
  }

  // Back button click handler
  backBtn.addEventListener('click', () => {
    if (historyStack.length > 0) {
      forwardStack.unshift(currentIndex); // save current index in forward stack
      if (forwardStack.length > maxPreload) forwardStack.pop();

      const prevIndex = historyStack.pop();
      showImage(prevIndex);
    }
  });

  // Forward button click handler
  forwardBtn.addEventListener('click', () => {
    if (currentIndex < links.length - 1) {
      // Save current index in history stack
      historyStack.push(currentIndex);
      if (historyStack.length > maxHistory) historyStack.shift();

      let nextIndex;
      // If user went back before and forwardStack has entries, pop from forwardStack first
      if (forwardStack.length > 0) {
        nextIndex = forwardStack.shift();
      } else {
        nextIndex = currentIndex + 1;
      }

      showImage(nextIndex);
    }
  });

  // Load links.txt and start
  fetch('links.txt')
    .then(response => response.text())
    .then(text => {
      links = text.trim().split('\n').filter(Boolean);
      if (links.length === 0) {
        imgElement.alt = "No images found in links.txt";
        forwardBtn.disabled = true;
        backBtn.disabled = true;
        return;
      }
      // Show a random image on start
      currentIndex = Math.floor(Math.random() * links.length);
      showImage(currentIndex);
    })
    .catch(err => {
      imgElement.alt = "Failed to load links.txt";
      console.error(err);
    });
</script>

</body>
</html>
